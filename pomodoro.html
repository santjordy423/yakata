<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‹æ‰‹ã«ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ â€” æ€ æƒ°ãªé›‘ç¨®ã¨ç‹ã®é¤¨</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { min-height: 100vh; overflow: auto; font-family: 'Zen Kaku Gothic New', sans-serif; }
.back-link {
  position: fixed; top: 16px; left: 16px; z-index: 100;
  color: rgba(255,107,107,0.5); font-size: 0.75rem; text-decoration: none;
  letter-spacing: 0.1em; transition: color 0.2s;
}
.back-link:hover { color: #ff6b6b; }
#settings-btn {
  position: fixed; top: 16px; right: 16px; z-index: 100;
  background: transparent; border: none;
  color: rgba(255,107,107,0.45); font-size: 0.75rem;
  cursor: pointer; letter-spacing: 0.08em; transition: color 0.2s;
  font-family: 'Zen Kaku Gothic New', sans-serif; padding: 0;
}
#settings-btn:hover { color: #ff6b6b; }
.timer-display {
  font-family: 'Orbitron', monospace;
  text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
}
@keyframes pulse-glow {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
.pulse-animation { animation: pulse-glow 2s ease-in-out infinite; }
@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.progress-ring { transition: stroke-dashoffset 1s linear; }

#app-container {
  min-height: 100vh; width: 100%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 64px 32px 32px; position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
}
.bg-deco { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
.bg-circle-1 {
  position: absolute; top: 25%; left: 25%;
  width: 384px; height: 384px; border-radius: 50%; opacity: 0.1;
  animation: rotate 60s linear infinite;
  background: radial-gradient(circle, #ff6b6b 0%, transparent 70%);
}
.bg-circle-2 {
  position: absolute; bottom: 25%; right: 25%;
  width: 320px; height: 320px; border-radius: 50%; opacity: 0.1;
  animation: rotate 60s linear infinite reverse;
  background: radial-gradient(circle, #4ecdc4 0%, transparent 70%);
}
.content { position: relative; z-index: 10; text-align: center; }
#status-label { font-size: 1.75rem; font-weight: 700; letter-spacing: 0.1em; color: #ff6b6b; }
.timer-wrapper { position: relative; display: inline-block; margin: 32px 0; }
.timer-svg { width: 256px; height: 256px; transform: rotate(-90deg); }
@media (min-width: 768px) {
  .timer-svg { width: 320px; height: 320px; }
  #status-label { font-size: 2rem; }
}
.timer-inner {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
#timer-display { font-size: 3rem; font-weight: 900; color: #ff6b6b; }
@media (min-width: 768px) { #timer-display { font-size: 4rem; } }
#cycle-info { font-size: 0.875rem; margin-top: 8px; opacity: 0.6; color: #e0e0e0; }
.session-info { color: #a0a0b0; }
#completed-count { font-weight: 700; color: #4ecdc4; }
#current-time-wrap { margin-top: 32px; font-size: 0.75rem; opacity: 0.5; color: #808090; }

/* === éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« === */
#settings-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.6); z-index: 200;
  backdrop-filter: blur(2px);
}
#settings-panel {
  display: none; position: fixed;
  top: 50%; left: 50%; transform: translate(-50%, -50%);
  z-index: 300; background: #0f0f23;
  border: 1px solid rgba(255,107,107,0.2); border-radius: 16px;
  padding: 24px; width: min(360px, 90vw);
  box-shadow: 0 0 60px rgba(255,107,107,0.08), 0 20px 60px rgba(0,0,0,0.5);
}
.settings-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px;
}
.settings-header > span { font-size: 0.85rem; color: rgba(255,107,107,0.75); letter-spacing: 0.1em; }
.settings-close {
  background: transparent; border: none; color: rgba(128,128,144,0.5);
  font-size: 1.3rem; cursor: pointer; padding: 0; line-height: 1; transition: color 0.2s;
}
.settings-close:hover { color: rgba(255,107,107,0.8); }
.settings-section { border-top: 1px solid rgba(255,255,255,0.05); padding-top: 16px; margin-top: 16px; }
.settings-section-title { font-size: 0.72rem; color: rgba(200,200,220,0.65); margin-bottom: 10px; letter-spacing: 0.1em; }
.settings-desc { font-size: 0.63rem; color: rgba(128,128,144,0.45); margin-top: 2px; }
.settings-row-space { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
.sound-type-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
.time-chime-row { display: flex; align-items: center; gap: 8px; }
.sound-type-btn {
  background: transparent; border: 1px solid rgba(255,107,107,0.2);
  color: rgba(255,107,107,0.45); padding: 4px 12px; border-radius: 20px;
  font-family: 'Zen Kaku Gothic New', sans-serif; font-size: 0.7rem;
  cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em;
}
.sound-type-btn:hover { border-color: rgba(255,107,107,0.6); color: rgba(255,107,107,0.8); }
.sound-type-btn.active { border-color: rgba(255,107,107,0.75); color: #ff6b6b; background: rgba(255,107,107,0.08); }
.toggle-btn {
  background: rgba(255,107,107,0.08); border: 1px solid rgba(255,107,107,0.4);
  color: #ff6b6b; padding: 4px 12px; border-radius: 20px;
  font-family: 'Zen Kaku Gothic New', sans-serif; font-size: 0.7rem;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
  min-width: 40px; text-align: center;
}
.toggle-btn.off { background: transparent; border-color: rgba(128,128,144,0.25); color: rgba(128,128,144,0.4); }
.preview-btn {
  background: transparent; border: 1px solid rgba(78,205,196,0.3);
  color: rgba(78,205,196,0.55); padding: 4px 10px; border-radius: 20px;
  font-family: 'Zen Kaku Gothic New', sans-serif; font-size: 0.7rem;
  cursor: pointer; transition: all 0.2s; white-space: nowrap;
}
.preview-btn:hover { border-color: rgba(78,205,196,0.7); color: #4ecdc4; }
.time-input {
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,107,107,0.2);
  color: rgba(200,200,220,0.8); padding: 4px 8px; border-radius: 8px;
  font-family: 'Orbitron', monospace; font-size: 0.75rem; width: 100px;
  color-scheme: dark;
}
.time-input:focus { outline: none; border-color: rgba(255,107,107,0.5); }
</style>
</head>
<body>
<a href="index.html" class="back-link">â† ã‚‚ã©ã‚‹</a>
<button id="settings-btn" onclick="openSettings()">âš™ éŸ³å£°è¨­å®š</button>

<div id="app-container">
  <div class="bg-deco">
    <div class="bg-circle-1"></div>
    <div class="bg-circle-2"></div>
  </div>
  <div class="content">
    <div style="margin-bottom: 32px;">
      <span id="status-label" class="pulse-animation">ä½œæ¥­ä¸­</span>
    </div>
    <div class="timer-wrapper">
      <svg class="timer-svg" viewBox="0 0 200 200">
        <circle cx="100" cy="100" r="90" fill="none" stroke="#2a2a4a" stroke-width="8"/>
        <circle id="progress-ring" class="progress-ring" cx="100" cy="100" r="90"
          fill="none" stroke="#ff6b6b" stroke-width="8" stroke-linecap="round"
          stroke-dasharray="565.48" stroke-dashoffset="0"/>
      </svg>
      <div class="timer-inner">
        <div id="timer-display" class="timer-display">25:00</div>
        <div id="cycle-info">ã‚µã‚¤ã‚¯ãƒ« #1</div>
      </div>
    </div>
    <div class="session-info" style="margin-bottom: 8px;">
      <p style="font-size: 0.875rem;">æœ¬æ—¥ã®ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­: <span id="completed-count">0</span> å®Œäº†</p>
    </div>
    <div class="session-info">
      <p style="font-size: 0.75rem; opacity: 0.7;">æ¬¡ã®ä¼‘æ†©ã¾ã§: <span id="next-break-time">--:--</span></p>
    </div>
    <div id="current-time-wrap">
      ç¾åœ¨æ™‚åˆ»: <span id="current-time">00:00:00</span>
    </div>
  </div>
</div>

<!-- éŸ³å£°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settings-overlay" onclick="closeSettings()"></div>
<div id="settings-panel">
  <div class="settings-header">
    <span>ğŸ”Š éŸ³å£°è¨­å®š</span>
    <button class="settings-close" onclick="closeSettings()">Ã—</button>
  </div>

  <div class="settings-section" style="border-top: none; padding-top: 0; margin-top: 0;">
    <div class="settings-section-title">éŸ³ã®ç¨®é¡</div>
    <div class="sound-type-row">
      <button class="sound-type-btn active" id="stype-poon" onclick="setSoundType('poon')">ãƒãƒ¼ãƒ³</button>
      <button class="sound-type-btn" id="stype-chime" onclick="setSoundType('chime')">ãƒãƒ£ã‚¤ãƒ </button>
      <button class="sound-type-btn" id="stype-pinpon" onclick="setSoundType('pinpon')">ãƒ”ãƒ³ãƒãƒ³</button>
      <button class="preview-btn" onclick="previewSound()">â–¶ è©¦è´</button>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-row-space">
      <div>
        <div class="settings-section-title">ã‚µã‚¤ã‚¯ãƒ«é€šçŸ¥</div>
        <div class="settings-desc">ä½œæ¥­ãƒ»ä¼‘æ†©ã®åˆ‡ã‚Šæ›¿ã‚ã‚Šã«é³´ã‚‰ã™</div>
      </div>
      <button id="cycle-toggle" class="toggle-btn" onclick="toggleCycleChime()">ON</button>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title">æ™‚åˆ»ãƒãƒ£ã‚¤ãƒ </div>
    <div class="time-chime-row">
      <input type="time" id="chime0-time" class="time-input" value="12:00" onchange="onTimeChimeInput(0)">
      <button id="chime0-toggle" class="toggle-btn" onclick="toggleTimeChime(0)">ON</button>
      <button class="preview-btn" onclick="previewSound()">â–¶ è©¦è´</button>
    </div>
    <div class="time-chime-row" style="margin-top: 10px;">
      <input type="time" id="chime1-time" class="time-input" value="17:00" onchange="onTimeChimeInput(1)">
      <button id="chime1-toggle" class="toggle-btn" onclick="toggleTimeChime(1)">ON</button>
      <button class="preview-btn" onclick="previewSound()">â–¶ è©¦è´</button>
    </div>
  </div>
</div>

<script>
const WORK_DURATION = 25 * 60;
const BREAK_DURATION = 5 * 60;
const CYCLE_DURATION = WORK_DURATION + BREAK_DURATION;
const CIRCUMFERENCE = 2 * Math.PI * 90;

function getSecondsSinceMidnight() {
  const now = new Date();
  return now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
}

function getCurrentPhaseInfo() {
  const secondsSinceMidnight = getSecondsSinceMidnight();
  const cycleNumber = Math.floor(secondsSinceMidnight / CYCLE_DURATION) + 1;
  const positionInCycle = secondsSinceMidnight % CYCLE_DURATION;
  const isWorking = positionInCycle < WORK_DURATION;
  const remainingInPhase = isWorking
    ? WORK_DURATION - positionInCycle
    : CYCLE_DURATION - positionInCycle;
  const phaseDuration = isWorking ? WORK_DURATION : BREAK_DURATION;
  const elapsedInPhase = phaseDuration - remainingInPhase;
  const progress = elapsedInPhase / phaseDuration;
  const completedPomodoros = isWorking ? cycleNumber - 1 : cycleNumber;
  const timeUntilNextBreak = isWorking ? remainingInPhase : CYCLE_DURATION + WORK_DURATION - (positionInCycle - WORK_DURATION);
  return { isWorking, remainingInPhase, cycleNumber, progress, completedPomodoros, timeUntilNextBreak };
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

function updateDisplay(info) {
  const primaryColor = '#ff6b6b';
  const secondaryColor = '#4ecdc4';
  const currentColor = info.isWorking ? primaryColor : secondaryColor;

  const statusLabel = document.getElementById('status-label');
  statusLabel.textContent = info.isWorking ? 'ä½œæ¥­ä¸­' : 'ä¼‘æ†©ä¸­';
  statusLabel.style.color = currentColor;

  const timerDisplay = document.getElementById('timer-display');
  timerDisplay.textContent = formatTime(info.remainingInPhase);
  timerDisplay.style.color = currentColor;

  const progressRing = document.getElementById('progress-ring');
  progressRing.style.strokeDashoffset = CIRCUMFERENCE * (1 - info.progress);
  progressRing.style.stroke = currentColor;

  document.getElementById('cycle-info').textContent = `ã‚µã‚¤ã‚¯ãƒ« #${info.cycleNumber}`;
  document.getElementById('completed-count').textContent = info.completedPomodoros;
  document.getElementById('next-break-time').textContent = formatTime(info.timeUntilNextBreak);
  document.getElementById('current-time').textContent = new Date().toLocaleTimeString('ja-JP', { hour12: false });
}

// === éŸ³å£°è¨­å®š ===
let audioCtx = null;
let soundType = 'poon';
let cycleChimeEnabled = true;
let timeChimes = [
  { enabled: true, hour: 12, minute: 0, lastPlayed: '' },
  { enabled: true, hour: 17, minute: 0, lastPlayed: '' }
];
let prevIsWorking = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function playTone(ctx, freq, startTime, duration, vol) {
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(ctx.destination);
  gain.gain.setValueAtTime(0, startTime);
  gain.gain.linearRampToValueAtTime(vol, startTime + 0.01);
  gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
  osc.start(startTime); osc.stop(startTime + duration);

  // ãƒ™ãƒ«ã‚‰ã—ã•ã‚’å‡ºã™å€éŸ³
  const osc2 = ctx.createOscillator();
  const gain2 = ctx.createGain();
  osc2.type = 'sine';
  osc2.frequency.value = freq * 2.756;
  osc2.connect(gain2);
  gain2.connect(ctx.destination);
  gain2.gain.setValueAtTime(0, startTime);
  gain2.gain.linearRampToValueAtTime(vol * 0.35, startTime + 0.01);
  gain2.gain.exponentialRampToValueAtTime(0.001, startTime + duration * 0.5);
  osc2.start(startTime); osc2.stop(startTime + duration);
}

function playPoon(ctx) {
  playTone(ctx, 523.25, ctx.currentTime, 3.5, 0.45);
}

function playChimeMelody(ctx, ascending) {
  const t = ctx.currentTime;
  const notes = ascending
    ? [523.25, 659.25, 783.99, 1046.5]   // C5â†’E5â†’G5â†’C6
    : [783.99, 659.25, 523.25, 392.00];   // G5â†’E5â†’C5â†’G4
  notes.forEach((freq, i) => playTone(ctx, freq, t + i * 0.45, 1.8, 0.3));
}

function playPinpon(ctx, up) {
  const t = ctx.currentTime;
  const [f1, f2] = up ? [523.25, 783.99] : [880, 659.25];
  playTone(ctx, f1, t, 0.9, 0.38);
  playTone(ctx, f2, t + 0.38, 0.9, 0.38);
}

function playSound(ascending) {
  const ctx = getAudioCtx();
  if (soundType === 'poon') playPoon(ctx);
  else if (soundType === 'chime') playChimeMelody(ctx, ascending);
  else if (soundType === 'pinpon') playPinpon(ctx, ascending);
}

// --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
function openSettings() {
  getAudioCtx();
  document.getElementById('settings-overlay').style.display = 'block';
  document.getElementById('settings-panel').style.display = 'block';
}

function closeSettings() {
  document.getElementById('settings-overlay').style.display = 'none';
  document.getElementById('settings-panel').style.display = 'none';
}

function setSoundType(type) {
  soundType = type;
  document.querySelectorAll('.sound-type-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('stype-' + type).classList.add('active');
}

function toggleCycleChime() {
  cycleChimeEnabled = !cycleChimeEnabled;
  const btn = document.getElementById('cycle-toggle');
  btn.textContent = cycleChimeEnabled ? 'ON' : 'OFF';
  btn.classList.toggle('off', !cycleChimeEnabled);
}

function toggleTimeChime(idx) {
  timeChimes[idx].enabled = !timeChimes[idx].enabled;
  const btn = document.getElementById('chime' + idx + '-toggle');
  btn.textContent = timeChimes[idx].enabled ? 'ON' : 'OFF';
  btn.classList.toggle('off', !timeChimes[idx].enabled);
}

function onTimeChimeInput(idx) {
  const val = document.getElementById('chime' + idx + '-time').value;
  if (!val) return;
  const [h, m] = val.split(':').map(Number);
  timeChimes[idx].hour = h;
  timeChimes[idx].minute = m;
  timeChimes[idx].lastPlayed = ''; // æ–°ã—ã„æ™‚åˆ»ã§å†ç™ºç«ã§ãã‚‹ã‚ˆã†ãƒªã‚»ãƒƒãƒˆ
}

function previewSound() {
  playSound(true);
}

// --- ãƒãƒ£ã‚¤ãƒ åˆ¤å®š ---
function checkCycleChime(info) {
  if (!cycleChimeEnabled) return;
  if (prevIsWorking === null) { prevIsWorking = info.isWorking; return; }
  if (info.isWorking !== prevIsWorking) {
    prevIsWorking = info.isWorking;
    playSound(info.isWorking); // ä½œæ¥­é–‹å§‹=ascendingã€ä¼‘æ†©é–‹å§‹=descending
  }
}

function checkTimeChimes() {
  const now = new Date();
  const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
  if (s !== 0) return;
  timeChimes.forEach((chime, idx) => {
    if (!chime.enabled || chime.hour !== h || chime.minute !== m) return;
    const key = `${h}:${String(m).padStart(2, '0')}`;
    if (chime.lastPlayed === key) return;
    chime.lastPlayed = key;
    playSound(true);
  });
}

function tick() {
  const info = getCurrentPhaseInfo();
  updateDisplay(info);
  checkCycleChime(info);
  checkTimeChimes();
}

setInterval(tick, 1000);
tick();
</script>
</body>
</html>
