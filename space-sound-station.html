<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COSMO-8 SOUND STATION // 宇宙音響研究所</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');

  :root {
    --black: #050810;
    --panel: #0a0f1e;
    --panel2: #0d1528;
    --border: #1a2a4a;
    --cyan: #00ffff;
    --green: #00ff88;
    --amber: #ffaa00;
    --red: #ff3355;
    --purple: #aa44ff;
    --dim: #334466;
    --text: #88aacc;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* starfield */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 30% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 20%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 10%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 20% 80%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 90%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 45% 70%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 15% 55%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 65% 35%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(2px 2px at 55% 85%, rgba(0,255,255,0.3) 0%, transparent 100%),
      radial-gradient(2px 2px at 25% 25%, rgba(170,68,255,0.3) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  /* HEADER */
  header {
    text-align: center;
    padding: 30px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
    position: relative;
  }

  .station-id {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    letter-spacing: 6px;
    color: var(--dim);
    margin-bottom: 8px;
  }

  h1 {
    font-family: 'Orbitron', monospace;
    font-size: clamp(20px, 4vw, 36px);
    font-weight: 900;
    color: var(--cyan);
    text-shadow: 0 0 20px rgba(0,255,255,0.5), 0 0 40px rgba(0,255,255,0.2);
    letter-spacing: 4px;
  }

  .subtitle {
    font-size: 11px;
    color: var(--dim);
    letter-spacing: 3px;
    margin-top: 6px;
  }

  .status-bar {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-top: 12px;
    font-size: 10px;
  }

  .status-item {
    color: var(--dim);
  }

  .status-item span {
    color: var(--green);
  }

  /* PANELS */
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
  }

  .panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--cyan), transparent);
    opacity: 0.4;
  }

  .panel-label {
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 4px;
    color: var(--amber);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* BGM SECTION */
  .bgm-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-label {
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 2px;
  }

  /* SELECT */
  select {
    background: var(--panel2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 2px;
    width: 100%;
    cursor: pointer;
    outline: none;
    appearance: none;
  }

  select:focus { border-color: var(--cyan); }

  /* SLIDERS */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  input[type=range] {
    flex: 1;
    -webkit-appearance: none;
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
  }

  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--cyan);
    cursor: pointer;
    box-shadow: 0 0 8px var(--cyan);
  }

  .slider-val {
    font-size: 11px;
    color: var(--cyan);
    min-width: 36px;
    text-align: right;
  }

  /* VISUALIZER */
  .visualizer-wrap {
    margin: 16px 0;
    border: 1px solid var(--border);
    border-radius: 2px;
    overflow: hidden;
    height: 60px;
    background: var(--panel2);
    position: relative;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  .viz-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 3px;
    pointer-events: none;
  }

  /* TRANSPORT */
  .transport {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* BUTTONS */
  .btn {
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    letter-spacing: 2px;
    padding: 10px 20px;
    border: 1px solid;
    border-radius: 2px;
    cursor: pointer;
    background: transparent;
    transition: all 0.1s;
    position: relative;
    overflow: hidden;
  }

  .btn-cyan {
    border-color: var(--cyan);
    color: var(--cyan);
  }

  .btn-cyan:hover, .btn-cyan.active {
    background: rgba(0,255,255,0.1);
    box-shadow: 0 0 16px rgba(0,255,255,0.3);
  }

  .btn-green {
    border-color: var(--green);
    color: var(--green);
  }

  .btn-green:hover {
    background: rgba(0,255,136,0.1);
    box-shadow: 0 0 16px rgba(0,255,136,0.3);
  }

  .btn-red {
    border-color: var(--red);
    color: var(--red);
  }

  .btn-red:hover {
    background: rgba(255,51,85,0.1);
    box-shadow: 0 0 16px rgba(255,51,85,0.3);
  }

  .btn-amber {
    border-color: var(--amber);
    color: var(--amber);
  }

  .btn-amber:hover {
    background: rgba(255,170,0,0.1);
    box-shadow: 0 0 16px rgba(255,170,0,0.3);
  }

  /* SOUND BOARD */
  .soundboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 10px;
  }

  .se-btn {
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 14px 12px;
    cursor: pointer;
    text-align: left;
    transition: all 0.1s;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    position: relative;
    overflow: hidden;
  }

  .se-btn::after {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.1s;
  }

  .se-btn:active::after {
    opacity: 1;
    background: rgba(255,255,255,0.05);
  }

  .se-btn:hover {
    border-color: var(--dim);
    background: var(--panel);
  }

  .se-btn.playing {
    border-color: var(--cyan);
    box-shadow: 0 0 12px rgba(0,255,255,0.2);
  }

  .se-name {
    font-size: 12px;
    color: var(--cyan);
    margin-bottom: 4px;
    display: block;
  }

  .se-name-jp {
    font-size: 10px;
    color: var(--dim);
  }

  .se-indicator {
    position: absolute;
    top: 8px; right: 8px;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--dim);
  }

  .se-btn.playing .se-indicator {
    background: var(--cyan);
    box-shadow: 0 0 6px var(--cyan);
    animation: blink 0.3s ease;
  }

  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }

  /* LOG */
  .log {
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 10px 14px;
    font-size: 10px;
    color: var(--dim);
    min-height: 32px;
    letter-spacing: 1px;
  }

  .log span { color: var(--green); }

  footer {
    text-align: center;
    padding: 20px;
    font-size: 10px;
    color: var(--dim);
    letter-spacing: 2px;
    margin-top: 8px;
  }

  footer a { color: var(--dim); text-decoration: none; }
  footer a:hover { color: var(--cyan); }

  @media (max-width: 600px) {
    .bgm-controls { grid-template-columns: 1fr; }
    .soundboard { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="station-id">UNIT-7 // SECTOR 4 // DEEP SPACE RELAY</div>
    <h1>COSMO-8 SOUND STATION</h1>
    <div class="subtitle">宇宙音響研究所 ── 8BIT STELLAR AUDIO SYSTEM</div>
    <div class="status-bar">
      <div class="status-item">SYS: <span id="sysStatus">STANDBY</span></div>
      <div class="status-item">FREQ: <span id="freqDisplay">---</span> Hz</div>
      <div class="status-item">SEC: <span id="sectionDisplay">--</span></div>
      <div class="status-item">TIME: <span id="timeDisplay">00:00</span></div>
    </div>
  </header>

  <!-- BGM GENERATOR -->
  <div class="panel">
    <div class="panel-label">▶ BGM GENERATOR // 宇宙BGM生成</div>

    <div class="bgm-controls">
      <div class="control-group">
        <div class="control-label">PATTERN // パターン</div>
        <select id="bgmPattern">
          <optgroup label="── 既存 ──">
            <option value="space">DEEP SPACE // 深宇宙</option>
            <option value="warp">WARP DRIVE // ワープ航行</option>
            <option value="planet">ALIEN PLANET // 異星地表</option>
            <option value="battle">SPACE BATTLE // 宇宙戦闘</option>
            <option value="credits">ENDING CREDITS // エンディング</option>
          </optgroup>
          <optgroup label="── 物悲しい・エモい系 ──">
            <option value="elegy">STELLAR ELEGY // 星の挽歌</option>
            <option value="lost">SIGNAL LOST // 消えた信号</option>
            <option value="last_orbit">LAST ORBIT // 最後の軌道</option>
            <option value="ghost_star">GHOST STAR // 幽霊星</option>
          </optgroup>
          <optgroup label="── レトロゲーム系 ──">
            <option value="dungeon">SPACE DUNGEON // 宇宙迷宮</option>
            <option value="overworld">OVERWORLD // 宇宙フィールド</option>
            <option value="boss">BOSS APPROACH // 強敵接近</option>
            <option value="victory">MISSION CLEAR // ミッション完了</option>
          </optgroup>
          <optgroup label="── ゆったり癒し系 ──">
            <option value="lofi_drift">LOFI DRIFT // 漂流ローファイ</option>
            <option value="nebula_rain">NEBULA RAIN // 星雲の雨</option>
            <option value="morning_station">MORNING STATION // 朝の宇宙港</option>
            <option value="stardust">STARDUST // 星屑</option>
          </optgroup>
        </select>
      </div>
      <div class="control-group">
        <div class="control-label">TEMPO // テンポ</div>
        <div class="slider-row">
          <input type="range" id="tempoSlider" min="60" max="200" value="120">
          <span class="slider-val" id="tempoVal">120</span>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">VOLUME // ボリューム</div>
        <div class="slider-row">
          <input type="range" id="volSlider" min="0" max="100" value="60">
          <span class="slider-val" id="volVal">60</span>
        </div>
      </div>
      <div class="control-group">
        <div class="control-label">REVERB // リバーブ</div>
        <div class="slider-row">
          <input type="range" id="reverbSlider" min="0" max="100" value="40">
          <span class="slider-val" id="reverbVal">40</span>
        </div>
      </div>
    </div>

    <div class="visualizer-wrap">
      <canvas id="vizCanvas"></canvas>
      <div class="viz-overlay" id="vizText">── AUDIO SIGNAL INACTIVE ──</div>
    </div>

    <div class="transport">
      <button class="btn btn-cyan" id="playBtn" onclick="toggleBGM()">▶ LAUNCH</button>
      <button class="btn btn-amber" onclick="randomizeBGM()">⟳ RANDOM</button>
      <button class="btn btn-green" onclick="generateNew()">◈ NEW PATTERN</button>
    </div>
  </div>

  <!-- SOUND BOARD -->
  <div class="panel">
    <div class="panel-label">▶ SOUND EFFECTS // 効果音ボード</div>
    <div class="soundboard" id="soundboard"></div>
  </div>

  <!-- LOG -->
  <div class="log" id="log">SYS // <span>システム待機中</span>... 音響ユニット起動準備完了</div>

  <footer>
    <a href="index.html">← RETURN TO BASE</a>
    &nbsp;|&nbsp;
    COSMO-8 SOUND STATION // 怠惰な雑種と王の館
  </footer>

</div>

<script>
// ===== AUDIO ENGINE =====
let audioCtx = null;
let bgmNodes = [];
let bgmPlaying = false;
let bgmInterval = null;
let analyser = null;
let animFrame = null;
let playTime = 0;
let playTimer = null;

function getCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analyser.connect(audioCtx.destination);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function getVolume() {
  return parseFloat(document.getElementById('volSlider').value) / 100 * 0.4;
}

function getReverbAmount() {
  return parseFloat(document.getElementById('reverbSlider').value) / 100;
}

// Simple reverb using delay network
function createReverb(ctx, amount) {
  const delay = ctx.createDelay(0.5);
  const feedback = ctx.createGain();
  const wet = ctx.createGain();
  delay.delayTime.value = 0.15;
  feedback.gain.value = amount * 0.5;
  wet.gain.value = amount * 0.4;
  delay.connect(feedback);
  feedback.connect(delay);
  delay.connect(wet);
  return { input: delay, output: wet };
}

function playNote(freq, type, duration, startTime, volMult = 1) {
  const ctx = getCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const vol = getVolume() * volMult;
  const rev = createReverb(ctx, getReverbAmount());

  osc.type = type;
  osc.frequency.setValueAtTime(freq, startTime);

  gain.gain.setValueAtTime(0, startTime);
  gain.gain.linearRampToValueAtTime(vol, startTime + 0.01);
  gain.gain.setValueAtTime(vol, startTime + duration * 0.7);
  gain.gain.linearRampToValueAtTime(0, startTime + duration);

  osc.connect(gain);
  gain.connect(rev.input);
  gain.connect(analyser); // dry
  rev.output.connect(analyser);

  osc.start(startTime);
  osc.stop(startTime + duration + 0.05);

  bgmNodes.push(osc);
}

function playDrum(type, startTime) {
  const ctx = getCtx();
  const bufSize = ctx.sampleRate * 0.1;
  const buffer = ctx.createBuffer(1, bufSize, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  const vol = getVolume();

  if (type === 'kick') {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.frequency.setValueAtTime(150, startTime);
    osc.frequency.exponentialRampToValueAtTime(0.01, startTime + 0.3);
    gain.gain.setValueAtTime(vol * 1.5, startTime);
    gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.3);
    osc.connect(gain); gain.connect(analyser);
    osc.start(startTime); osc.stop(startTime + 0.35);
    bgmNodes.push(osc);
  } else if (type === 'snare') {
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.05));
    const src = ctx.createBufferSource();
    const gain = ctx.createGain();
    src.buffer = buffer;
    gain.gain.setValueAtTime(vol * 1.2, startTime);
    gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
    src.connect(gain); gain.connect(analyser);
    src.start(startTime);
    bgmNodes.push(src);
  } else if (type === 'hihat') {
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.02));
    const src = ctx.createBufferSource();
    const filter = ctx.createBiquadFilter();
    const gain = ctx.createGain();
    src.buffer = buffer;
    filter.type = 'highpass';
    filter.frequency.value = 8000;
    gain.gain.setValueAtTime(vol * 0.5, startTime);
    gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.05);
    src.connect(filter); filter.connect(gain); gain.connect(analyser);
    src.start(startTime);
    bgmNodes.push(src);
  }
}

// ===== BGM PATTERNS =====
const PATTERNS = {
  // ── 既存 ──────────────────────────────
  space: {
    name: 'DEEP SPACE',
    sectionA: {
      melody: [440,0,494,0,523,0,440,587,0,523,0,494,440,0,392,0],
      bass:   [110,110,0,0,123,123,0,0,131,131,0,0,110,110,0,0],
      drums:  ['kick',null,'hihat',null,'snare',null,'hihat',null,
               'kick',null,'hihat',null,'snare',null,'hihat',null],
      oscType:'square', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [880,0,988,0,1046,0,880,0,784,0,880,0,988,0,784,0],
      bass:   [110,0,0,123,0,0,131,0,110,0,0,123,0,0,110,0],
      drums:  [null,'hihat',null,'hihat','snare',null,'hihat',null,
               null,'hihat',null,'hihat','snare',null,'hihat',null],
      oscType:'triangle', bassType:'triangle', repeats:4,
    },
    sectionC: {
      // 宇宙の果てへ漂う、音が薄くなる
      melody: [523,0,0,0,494,0,0,0,523,0,494,0,0,440,0,0],
      bass:   [131,0,0,0,0,0,123,0,0,0,131,0,0,0,110,0],
      drums:  [null,null,'hihat',null,null,null,null,null,
               'kick',null,null,null,null,'hihat',null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  warp: {
    name: 'WARP DRIVE',
    sectionA: {
      melody: [659,587,523,659,587,0,784,0,698,659,587,523,659,0,587,0],
      bass:   [165,0,165,0,185,0,185,0,196,0,196,0,165,0,185,0],
      drums:  ['kick','hihat','kick','hihat','snare','hihat','kick','hihat',
               'kick','hihat','kick','hihat','snare','hihat','kick','hihat'],
      oscType:'sawtooth', bassType:'square', repeats:4,
    },
    sectionB: {
      melody: [784,880,784,659,784,880,988,880,784,659,698,784,659,587,523,587],
      bass:   [196,196,185,185,196,196,247,247,196,196,175,175,165,165,131,131],
      drums:  ['kick','kick','hihat','snare','kick','kick','hihat','snare',
               'kick','kick','hihat','snare','kick','kick','hihat','snare'],
      oscType:'sawtooth', bassType:'sawtooth', repeats:4,
    },
    sectionC: {
      // ワープ完了、エンジン減速、うねりが収まる
      melody: [988,0,880,0,784,0,698,0,659,0,587,0,523,0,0,0],
      bass:   [247,0,0,220,0,0,196,0,0,165,0,0,131,0,0,0],
      drums:  ['kick',null,null,'hihat',null,null,'snare',null,
               'kick',null,null,'hihat',null,null,null,null],
      oscType:'triangle', bassType:'triangle', repeats:2,
    },
  },
  planet: {
    name: 'ALIEN PLANET',
    sectionA: {
      melody: [369,0,415,0,369,329,0,415,440,0,415,0,369,0,329,0],
      bass:   [92,0,0,92,0,0,104,0,92,0,0,92,0,0,104,0],
      drums:  ['kick',null,null,'hihat',null,null,'snare',null,
               'kick',null,null,'hihat',null,null,'snare',null],
      oscType:'triangle', bassType:'sawtooth', repeats:4,
    },
    sectionB: {
      melody: [466,0,440,0,415,0,466,0,494,0,466,440,0,415,0,0],
      bass:   [116,0,0,0,104,0,0,0,123,0,0,0,104,0,0,0],
      drums:  [null,null,'hihat',null,'kick',null,null,'hihat',
               null,null,'hihat',null,'kick','snare',null,null],
      oscType:'sine', bassType:'sawtooth', repeats:4,
    },
    sectionC: {
      // 異星の夜明け、静かな神秘
      melody: [329,0,0,369,0,0,329,0,293,0,0,329,0,0,277,0],
      bass:   [82,0,0,0,92,0,0,0,73,0,0,0,82,0,0,0],
      drums:  [null,null,null,'hihat',null,null,null,null,
               null,'hihat',null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  battle: {
    name: 'SPACE BATTLE',
    sectionA: {
      melody: [880,831,880,0,987,880,831,740,880,0,831,880,987,0,880,831],
      bass:   [220,220,247,247,262,262,220,220,247,247,220,220,262,262,247,247],
      drums:  ['kick','hihat','snare','hihat','kick','hihat','snare','hihat',
               'kick','hihat','snare','hihat','kick','hihat','snare','hihat'],
      oscType:'sawtooth', bassType:'sawtooth', repeats:4,
    },
    sectionB: {
      melody: [659,0,698,0,740,0,784,740,698,0,659,0,698,659,623,0],
      bass:   [165,165,175,175,185,185,196,196,175,175,165,165,175,165,156,156],
      drums:  ['kick',null,'hihat','snare','kick',null,'hihat','snare',
               'kick',null,'hihat','snare','kick','kick','snare',null],
      oscType:'sawtooth', bassType:'square', repeats:4,
    },
    sectionC: {
      // 戦闘終結、残響、勝利か敗北かわからない静寂
      melody: [440,0,0,0,415,0,0,0,392,0,0,415,440,0,0,0],
      bass:   [110,0,0,0,104,0,0,0,98,0,0,0,110,0,0,0],
      drums:  ['kick',null,null,null,null,null,'snare',null,
               null,null,null,null,'kick',null,null,null],
      oscType:'triangle', bassType:'sine', repeats:2,
    },
  },
  credits: {
    name: 'ENDING CREDITS',
    sectionA: {
      melody: [523,0,587,0,659,0,698,0,784,0,880,0,784,0,698,0],
      bass:   [131,0,0,0,147,0,0,0,165,0,0,0,131,0,0,0],
      drums:  ['kick',null,'hihat',null,'snare',null,'hihat',null,
               'kick',null,'hihat',null,'snare',null,'hihat',null],
      oscType:'triangle', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [659,0,0,0,698,0,0,0,784,0,0,659,0,0,698,0],
      bass:   [165,0,0,0,175,0,0,0,196,0,0,0,165,0,0,0],
      drums:  [null,null,null,'hihat',null,null,null,'hihat',
               'kick',null,null,null,'snare',null,null,null],
      oscType:'sine', bassType:'triangle', repeats:4,
    },
    sectionC: {
      // ロールが終わり、スクリーンが暗くなる
      melody: [784,0,0,0,0,698,0,0,0,659,0,0,0,0,523,0],
      bass:   [196,0,0,0,0,0,175,0,0,0,165,0,0,0,131,0],
      drums:  [null,null,null,null,null,null,null,'hihat',
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },

  // ── 物悲しい・エモい系 ────────────────
  elegy: {
    name: 'STELLAR ELEGY // 星の挽歌',
    sectionA: {
      melody: [392,0,370,0,349,0,330,0,349,0,370,0,392,0,0,0],
      bass:   [98,0,0,0,87,0,0,0,87,0,0,0,98,0,0,0],
      drums:  [null,null,'hihat',null,null,null,'hihat',null,
               null,null,'hihat',null,'kick',null,null,null],
      oscType:'triangle', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [523,0,494,0,466,0,440,0,415,0,392,0,349,0,0,0],
      bass:   [131,0,0,0,123,0,0,0,104,0,0,0,87,0,0,0],
      drums:  ['kick',null,null,null,null,'hihat',null,null,
               'kick',null,null,null,'snare',null,null,null],
      oscType:'sine', bassType:'triangle', repeats:4,
    },
    sectionC: {
      // 星が消えていく、ピアノ一音ずつ
      melody: [330,0,0,0,0,349,0,0,0,0,330,0,0,0,311,0],
      bass:   [82,0,0,0,0,0,0,87,0,0,0,0,0,82,0,0],
      drums:  [null,null,null,null,null,null,null,null,
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  lost: {
    name: 'SIGNAL LOST // 消えた信号',
    sectionA: {
      melody: [440,0,0,415,0,392,0,0,370,0,349,0,0,330,0,0],
      bass:   [110,0,0,0,104,0,0,0,98,0,0,0,92,0,0,0],
      drums:  [null,null,null,'hihat',null,null,null,'hihat',
               null,null,null,'hihat',null,null,null,null],
      oscType:'sine', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [330,0,0,0,0,349,0,0,0,330,0,0,0,0,311,0],
      bass:   [82,0,0,0,0,0,87,0,0,0,0,82,0,0,0,0],
      drums:  [null,null,null,null,null,null,null,'hihat',
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:4,
    },
    sectionC: {
      // 最後の断片、ほぼ無音に近い
      melody: [311,0,0,0,0,0,0,0,293,0,0,0,0,0,0,0],
      bass:   [78,0,0,0,0,0,0,0,73,0,0,0,0,0,0,0],
      drums:  [null,null,null,null,null,null,null,null,
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  last_orbit: {
    name: 'LAST ORBIT // 最後の軌道',
    sectionA: {
      melody: [494,440,0,494,523,0,494,440,415,0,440,0,494,0,440,0],
      bass:   [123,0,110,0,131,0,110,0,104,0,110,0,123,0,0,0],
      drums:  ['kick',null,null,null,'hihat',null,null,null,
               'kick',null,null,null,'snare',null,null,null],
      oscType:'triangle', bassType:'sine', repeats:4,
    },
    sectionB: {
      melody: [523,0,587,0,659,0,587,0,523,0,587,523,494,0,523,0],
      bass:   [131,0,0,0,165,0,0,0,131,0,0,0,123,0,0,0],
      drums:  ['kick',null,'hihat',null,null,null,'hihat',null,
               'kick',null,'hihat',null,'snare',null,null,null],
      oscType:'triangle', bassType:'triangle', repeats:4,
    },
    sectionC: {
      melody: [392,0,0,0,415,0,0,0,440,0,0,415,0,392,0,0],
      bass:   [98,0,0,0,0,0,104,0,0,0,110,0,0,0,98,0],
      drums:  [null,null,null,null,null,null,'hihat',null,
               null,null,null,null,'kick',null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  ghost_star: {
    name: 'GHOST STAR // 幽霊星',
    sectionA: {
      melody: [311,0,277,0,311,0,330,0,277,0,0,261,0,277,0,0],
      bass:   [78,0,0,0,69,0,0,0,78,0,0,0,65,0,0,0],
      drums:  [null,null,'hihat',null,null,null,'hihat',null,
               'kick',null,null,null,null,'hihat',null,null],
      oscType:'sine', bassType:'sine', repeats:4,
    },
    sectionB: {
      melody: [293,0,0,277,0,0,261,0,246,0,0,261,0,277,0,0],
      bass:   [73,0,0,0,0,69,0,0,0,61,0,0,0,69,0,0],
      drums:  [null,null,null,'hihat',null,null,null,null,
               null,null,'hihat',null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:4,
    },
    sectionC: {
      // 幽霊が消える瞬間、ゆらぎだけ残る
      melody: [261,0,0,0,246,0,0,0,0,261,0,0,0,0,246,0],
      bass:   [65,0,0,0,0,0,61,0,0,0,0,65,0,0,0,0],
      drums:  [null,null,null,null,null,null,null,null,
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },

  // ── レトロゲームっぽい明るい曲 ────────
  dungeon: {
    name: 'SPACE DUNGEON // 宇宙迷宮',
    sectionA: {
      melody: [523,523,659,523,784,698,659,0,523,523,659,523,880,784,0,0],
      bass:   [131,0,131,0,165,0,165,0,131,0,131,0,220,0,0,0],
      drums:  ['kick','hihat','kick','hihat','kick','hihat','snare','hihat',
               'kick','hihat','kick','hihat','kick','hihat','snare','hihat'],
      oscType:'square', bassType:'square', repeats:4,
    },
    sectionB: {
      melody: [440,0,494,523,0,494,440,0,392,440,0,494,523,0,0,0],
      bass:   [110,0,0,123,0,0,110,0,98,0,0,110,131,0,0,0],
      drums:  ['kick',null,'hihat',null,'kick',null,'hihat',null,
               null,'hihat',null,'kick',null,'snare',null,null],
      oscType:'square', bassType:'triangle', repeats:4,
    },
    sectionC: {
      // 宝箱発見！キラキラ上昇
      melody: [523,659,784,880,988,880,784,659,784,880,988,1046,988,880,784,0],
      bass:   [131,0,165,0,220,0,196,0,196,0,247,0,247,220,196,0],
      drums:  ['kick','hihat','kick','hihat','snare','hihat','kick','hihat',
               'kick','hihat','snare','hihat','kick',null,null,null],
      oscType:'square', bassType:'square', repeats:2,
    },
  },
  overworld: {
    name: 'OVERWORLD // 宇宙フィールド',
    sectionA: {
      melody: [659,784,880,784,659,523,587,659,698,784,880,988,880,784,659,0],
      bass:   [165,0,165,0,131,0,147,0,175,0,175,0,165,0,165,0],
      drums:  ['kick',null,'hihat',null,'kick',null,'hihat',null,
               'kick',null,'hihat',null,'snare',null,'hihat',null],
      oscType:'square', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [523,659,523,0,494,659,784,659,523,784,880,784,659,523,659,784],
      bass:   [131,0,131,0,123,0,196,0,131,0,220,0,165,0,165,0],
      drums:  ['kick','hihat',null,'hihat','kick','hihat',null,'hihat',
               'kick','hihat','snare','hihat','kick','hihat',null,'hihat'],
      oscType:'square', bassType:'square', repeats:4,
    },
    sectionC: {
      // 夕暮れ、惑星に沈む太陽
      melody: [880,0,784,0,698,0,659,0,587,0,523,0,494,0,440,0],
      bass:   [220,0,0,196,0,0,175,0,0,165,0,0,131,0,0,0],
      drums:  [null,'hihat',null,null,'kick',null,'hihat',null,
               null,null,'snare',null,null,'hihat',null,null],
      oscType:'triangle', bassType:'triangle', repeats:2,
    },
  },
  boss: {
    name: 'BOSS APPROACH // 強敵接近',
    sectionA: {
      melody: [220,0,220,246,0,220,0,196,220,0,246,0,261,246,220,0],
      bass:   [55,55,0,62,62,0,55,55,55,55,0,62,65,0,55,55],
      drums:  ['kick','kick','hihat','snare','kick','kick','hihat','snare',
               'kick','kick','hihat','snare','kick','kick','hihat','snare'],
      oscType:'sawtooth', bassType:'square', repeats:4,
    },
    sectionB: {
      melody: [440,466,440,0,415,440,466,440,392,415,440,0,466,440,415,392],
      bass:   [110,110,104,104,110,110,116,116,98,98,110,110,116,110,104,98],
      drums:  ['kick','kick','snare','kick','kick','kick','snare','hihat',
               'kick','kick','snare','kick','kick','kick','snare','snare'],
      oscType:'sawtooth', bassType:'sawtooth', repeats:4,
    },
    sectionC: {
      // ボスの真の姿が現れる、重低音のみ
      melody: [110,0,0,0,123,0,0,0,110,0,0,0,98,0,0,0],
      bass:   [55,55,55,0,0,62,62,62,0,0,55,55,55,0,49,49],
      drums:  ['kick',null,'kick',null,'snare',null,'kick',null,
               'kick',null,'kick','kick','snare',null,null,null],
      oscType:'sawtooth', bassType:'sawtooth', repeats:2,
    },
  },
  victory: {
    name: 'MISSION CLEAR // ミッション完了',
    sectionA: {
      melody: [523,659,784,1047,880,784,659,784,880,988,880,784,659,523,0,0],
      bass:   [131,0,165,0,220,0,175,0,220,0,220,0,165,131,0,0],
      drums:  ['kick','hihat','kick','hihat','snare','hihat','kick','hihat',
               'kick','hihat','kick','hihat','snare',null,null,null],
      oscType:'square', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [1047,0,988,0,1047,0,1175,0,1047,988,880,784,880,988,1047,0],
      bass:   [262,0,0,0,262,0,0,0,262,0,220,0,220,0,262,0],
      drums:  ['kick',null,'hihat',null,'kick',null,'hihat',null,
               'kick','hihat','snare','hihat','kick','hihat','snare',null],
      oscType:'square', bassType:'square', repeats:4,
    },
    sectionC: {
      // エピローグ、余韻に浸る
      melody: [784,0,0,880,0,0,784,0,659,0,0,698,0,0,659,0],
      bass:   [196,0,0,0,220,0,0,0,165,0,0,0,175,0,0,0],
      drums:  ['kick',null,null,'hihat',null,null,null,'hihat',
               null,null,'snare',null,null,null,null,null],
      oscType:'triangle', bassType:'triangle', repeats:2,
    },
  },

  // ── ゆったり癒し系（ローファイっぽい）──
  lofi_drift: {
    name: 'LOFI DRIFT // 漂流ローファイ',
    sectionA: {
      melody: [392,0,0,440,0,0,494,0,0,440,0,392,0,0,349,0],
      bass:   [98,0,0,0,0,110,0,0,0,0,98,0,0,0,87,0],
      drums:  [null,null,'hihat',null,null,null,'hihat',null,
               'kick',null,null,null,'hihat',null,null,null],
      oscType:'triangle', bassType:'sine', repeats:4,
    },
    sectionB: {
      melody: [440,0,0,494,0,0,523,0,0,494,0,440,0,0,415,0],
      bass:   [110,0,0,0,0,123,0,0,0,0,110,0,0,0,104,0],
      drums:  [null,null,'hihat',null,null,null,'hihat',null,
               null,'hihat',null,null,'kick',null,'hihat',null],
      oscType:'sine', bassType:'sine', repeats:4,
    },
    sectionC: {
      // 眠りに落ちる、音がさらに遠くなる
      melody: [440,0,0,0,0,0,415,0,0,0,0,0,392,0,0,0],
      bass:   [110,0,0,0,0,0,0,104,0,0,0,0,0,98,0,0],
      drums:  [null,null,null,null,null,null,'hihat',null,
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  nebula_rain: {
    name: 'NEBULA RAIN // 星雲の雨',
    sectionA: {
      melody: [523,0,0,587,0,0,523,0,494,0,0,523,0,0,440,0],
      bass:   [131,0,0,0,147,0,0,0,123,0,0,0,110,0,0,0],
      drums:  [null,null,null,'hihat',null,null,null,'hihat',
               null,null,null,'hihat',null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:4,
    },
    sectionB: {
      melody: [587,0,659,0,587,0,523,0,587,0,0,659,0,587,0,523],
      bass:   [147,0,0,0,165,0,0,0,147,0,0,0,131,0,0,0],
      drums:  ['kick',null,null,'hihat',null,null,'hihat',null,
               null,'hihat',null,null,'kick',null,'hihat',null],
      oscType:'triangle', bassType:'sine', repeats:4,
    },
    sectionC: {
      // 雨上がり、静寂と光
      melody: [659,0,0,0,0,587,0,0,0,0,523,0,0,0,0,587],
      bass:   [165,0,0,0,0,147,0,0,0,131,0,0,0,0,147,0],
      drums:  [null,null,null,null,null,null,null,'hihat',
               null,null,null,null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
  morning_station: {
    name: 'MORNING STATION // 朝の宇宙港',
    sectionA: {
      melody: [659,0,587,0,523,0,587,0,659,0,659,0,659,0,0,0],
      bass:   [165,0,0,0,131,0,0,0,165,0,0,0,165,0,0,0],
      drums:  [null,'hihat',null,'hihat',null,'hihat',null,'hihat',
               'kick',null,'hihat',null,null,'hihat',null,null],
      oscType:'triangle', bassType:'triangle', repeats:4,
    },
    sectionB: {
      melody: [659,784,880,784,659,0,698,784,659,0,587,659,523,0,0,0],
      bass:   [165,0,220,0,165,0,175,0,165,0,147,0,131,0,0,0],
      drums:  ['kick',null,'hihat',null,'kick',null,'hihat',null,
               'kick','hihat',null,'hihat','snare',null,null,null],
      oscType:'triangle', bassType:'triangle', repeats:4,
    },
    sectionC: {
      // 船が飛び立つ、遠ざかる景色
      melody: [880,0,0,784,0,0,698,0,0,659,0,0,587,0,0,523],
      bass:   [220,0,0,0,175,0,0,0,165,0,0,0,147,0,131,0],
      drums:  ['kick',null,null,'hihat',null,null,null,'hihat',
               null,null,'snare',null,null,null,null,null],
      oscType:'triangle', bassType:'sine', repeats:2,
    },
  },
  stardust: {
    name: 'STARDUST // 星屑',
    sectionA: {
      melody: [784,0,880,0,784,698,0,784,659,0,698,0,659,587,0,659],
      bass:   [196,0,0,0,175,0,0,0,165,0,0,0,147,0,0,0],
      drums:  [null,null,'hihat',null,null,null,'hihat',null,
               null,'hihat',null,null,'kick',null,'hihat',null],
      oscType:'triangle', bassType:'sine', repeats:4,
    },
    sectionB: {
      melody: [988,0,880,0,988,880,0,784,880,0,784,0,698,0,784,0],
      bass:   [247,0,0,0,220,0,0,0,220,0,0,0,175,0,0,0],
      drums:  [null,'hihat',null,null,null,'hihat',null,null,
               null,'hihat',null,'kick',null,'hihat',null,null],
      oscType:'sine', bassType:'sine', repeats:4,
    },
    sectionC: {
      // 星屑が地に降り積もる、最後の輝き
      melody: [1046,0,0,0,988,0,0,0,880,0,0,0,784,0,0,0],
      bass:   [262,0,0,0,247,0,0,0,220,0,0,0,196,0,0,0],
      drums:  [null,null,null,'hihat',null,null,null,null,
               null,null,'hihat',null,null,null,null,null],
      oscType:'sine', bassType:'sine', repeats:2,
    },
  },
};

let currentPattern = null;
let stepIndex = 0;
let currentSection = 'A'; // 'A' or 'B'
let sectionRepeat = 0;    // 今のセクションを何回繰り返したか

// セクション遷移順を返す（C未定義ならA→B→Aの2セクションループ）
function getSectionOrder(pat) {
  if (pat.sectionC) return ['A','B','C']; // A→B→C→A→B→C…
  if (pat.sectionA) return ['A','B'];
  return ['A'];
}

function getActiveSection(pat) {
  if (currentSection === 'C' && pat.sectionC) return pat.sectionC;
  if (currentSection === 'B' && pat.sectionB) return pat.sectionB;
  if (pat.sectionA) return pat.sectionA;
  return { melody: pat.melody, bass: pat.bass, drums: pat.drums,
           oscType: pat.oscType, bassType: pat.bassType };
}

function scheduleBeat() {
  const ctx = getCtx();
  const tempo = parseFloat(document.getElementById('tempoSlider').value);
  const stepDur = 60 / tempo / 4;
  const now = ctx.currentTime;
  const pat = currentPattern;
  const sec = getActiveSection(pat);
  const oscType = sec.oscType || pat.oscType;
  const bassType = sec.bassType || pat.bassType;
  const steps = sec.melody.length;

  for (let i = 0; i < 4; i++) {
    const si = (stepIndex + i) % steps;
    const t = now + i * stepDur;
    if (sec.melody[si]) playNote(sec.melody[si], oscType,  stepDur * 0.9, t, 0.8);
    if (sec.bass[si])   playNote(sec.bass[si],   bassType, stepDur * 1.8, t, 0.6);
    if (sec.drums[si])  playDrum(sec.drums[si], t);
  }

  const mf = sec.melody[stepIndex % steps];
  document.getElementById('freqDisplay').textContent = mf ? mf.toFixed(0) : '---';
  stepIndex = (stepIndex + 4) % steps;

  // セクション末尾でセクション遷移チェック
  if (stepIndex === 0 && pat.sectionA) {
    sectionRepeat++;
    const repeatsPerSection = sec.repeats || 2;
    if (sectionRepeat >= repeatsPerSection) {
      sectionRepeat = 0;
      const order = getSectionOrder(pat);
      const idx = order.indexOf(currentSection);
      currentSection = order[(idx + 1) % order.length];
      document.getElementById('sectionDisplay').textContent = `[ ${currentSection} ]`;
      log(`セクション切替 // ${currentSection} SECTION`);
    }
  }
}

function toggleBGM() {
  if (bgmPlaying) {
    stopBGM();
  } else {
    startBGM();
  }
}

function startBGM() {
  const patKey = document.getElementById('bgmPattern').value;
  currentPattern = PATTERNS[patKey];
  stepIndex = 0;
  currentSection = 'A';
  sectionRepeat = 0;
  bgmPlaying = true;

  const btn = document.getElementById('playBtn');
  btn.textContent = '■ ABORT';
  btn.classList.add('active');

  const hasSections = !!currentPattern.sectionA;
  document.getElementById('sectionDisplay').textContent = hasSections ? '[ A ]' : '';
  document.getElementById('sysStatus').textContent = 'BROADCASTING';
  document.getElementById('vizText').style.display = 'none';
  log(`BGM起動 // ${currentPattern.name} // TEMPO: ${document.getElementById('tempoSlider').value} BPM`);

  const tempo = parseFloat(document.getElementById('tempoSlider').value);
  const stepDur = 60 / tempo / 4;

  scheduleBeat();
  bgmInterval = setInterval(scheduleBeat, stepDur * 4 * 1000 * 0.95);

  startViz();
  playTime = 0;
  playTimer = setInterval(() => {
    playTime++;
    const m = String(Math.floor(playTime / 60)).padStart(2, '0');
    const s = String(playTime % 60).padStart(2, '0');
    document.getElementById('timeDisplay').textContent = `${m}:${s}`;
  }, 1000);
}

function stopBGM() {
  bgmPlaying = false;
  clearInterval(bgmInterval);
  clearInterval(playTimer);
  bgmNodes.forEach(n => { try { n.stop(); } catch(e) {} });
  bgmNodes = [];

  const btn = document.getElementById('playBtn');
  btn.textContent = '▶ LAUNCH';
  btn.classList.remove('active');

  document.getElementById('sysStatus').textContent = 'STANDBY';
  document.getElementById('vizText').style.display = 'flex';
  document.getElementById('freqDisplay').textContent = '---';
  stopViz();
  log('BGM停止 // システム待機モードへ移行');
}

function randomizeBGM() {
  const keys = Object.keys(PATTERNS);
  const k = keys[Math.floor(Math.random() * keys.length)];
  document.getElementById('bgmPattern').value = k;
  const tempos = [80, 100, 120, 140, 160];
  document.getElementById('tempoSlider').value = tempos[Math.floor(Math.random() * tempos.length)];
  document.getElementById('tempoVal').textContent = document.getElementById('tempoSlider').value;
  log(`ランダム設定 // ${PATTERNS[k].name}`);
  if (bgmPlaying) { stopBGM(); setTimeout(startBGM, 100); }
}

function generateNew() {
  const scales = [
    [261, 293, 329, 349, 392, 440, 494, 523],
    [261, 293, 311, 349, 392, 415, 466, 523],
    [220, 247, 261, 293, 329, 349, 392, 440],
  ];
  const scale = scales[Math.floor(Math.random() * scales.length)];
  const scaleHi = scale.map(n => n * 2);
  const patKey = document.getElementById('bgmPattern').value;
  const base = PATTERNS[patKey];

  function randMelody(notes) {
    return Array.from({length:16}, () => Math.random()<0.3 ? 0 : notes[Math.floor(Math.random()*notes.length)]);
  }

  // sectionA/B構造を持つ新パターンを生成
  const newPat = {
    name: base.name + ' [GEN]',
    sectionA: {
      melody: randMelody(scale),
      bass: (base.sectionA || base).bass,
      drums: (base.sectionA || base).drums,
      oscType: (base.sectionA || base).oscType,
      bassType: (base.sectionA || base).bassType,
    },
    sectionB: {
      melody: randMelody(scaleHi),
      bass: (base.sectionB || base.sectionA || base).bass,
      drums: (base.sectionB || base.sectionA || base).drums,
      oscType: (base.sectionB || base.sectionA || base).oscType,
      bassType: (base.sectionB || base.sectionA || base).bassType,
      repeats: 1,
    },
    repeats: 2,
  };
  currentPattern = newPat;
  log('新パターン生成 // A/Bセクション ランダム展開完了');
  if (bgmPlaying) { stopBGM(); setTimeout(startBGM, 100); }
}

// ===== VISUALIZER =====
function startViz() {
  const canvas = document.getElementById('vizCanvas');
  const ctx2 = canvas.getContext('2d');

  function draw() {
    if (!bgmPlaying) return;
    animFrame = requestAnimationFrame(draw);

    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    const bufLen = analyser.frequencyBinCount;
    const data = new Uint8Array(bufLen);
    analyser.getByteFrequencyData(data);

    ctx2.fillStyle = '#0d1528';
    ctx2.fillRect(0, 0, canvas.width, canvas.height);

    const barW = canvas.width / bufLen * 2.5;
    let x = 0;
    for (let i = 0; i < bufLen; i++) {
      const h = (data[i] / 255) * canvas.height;
      const hue = 180 + (data[i] / 255) * 60;
      ctx2.fillStyle = `hsl(${hue}, 100%, ${40 + data[i] / 255 * 30}%)`;
      ctx2.fillRect(x, canvas.height - h, barW - 1, h);
      x += barW;
    }
  }
  draw();
}

function stopViz() {
  cancelAnimationFrame(animFrame);
  const canvas = document.getElementById('vizCanvas');
  const ctx2 = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  ctx2.fillStyle = '#0d1528';
  ctx2.fillRect(0, 0, canvas.width, canvas.height);
}

// ===== SOUND EFFECTS =====
const SE_LIST = [
  {
    id: 'laser', name: 'LASER SHOT', jp: 'レーザー砲',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sawtooth';
      o.frequency.setValueAtTime(1200, now);
      o.frequency.exponentialRampToValueAtTime(100, now + 0.3);
      g.gain.setValueAtTime(getVolume() * 1.2, now);
      g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
      o.connect(g); g.connect(analyser);
      o.start(now); o.stop(now + 0.35);
    }
  },
  {
    id: 'warp', name: 'WARP ENGAGE', jp: 'ワープ突入',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sawtooth';
      o.frequency.setValueAtTime(200, now);
      o.frequency.exponentialRampToValueAtTime(4000, now + 0.8);
      g.gain.setValueAtTime(getVolume(), now);
      g.gain.setValueAtTime(getVolume(), now + 0.6);
      g.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
      o.connect(g); g.connect(analyser);
      o.start(now); o.stop(now + 1);
    }
  },
  {
    id: 'alert', name: 'RED ALERT', jp: '警告アラート',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      [0, 0.25, 0.5].forEach(offset => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'square';
        o.frequency.setValueAtTime(880, now + offset);
        o.frequency.setValueAtTime(440, now + offset + 0.1);
        g.gain.setValueAtTime(getVolume() * 0.8, now + offset);
        g.gain.exponentialRampToValueAtTime(0.001, now + offset + 0.22);
        o.connect(g); g.connect(analyser);
        o.start(now + offset); o.stop(now + offset + 0.25);
      });
    }
  },
  {
    id: 'beep', name: 'COMM BEEP', jp: '通信ビープ',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      [0, 0.15].forEach(offset => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 1760;
        g.gain.setValueAtTime(getVolume() * 0.6, now + offset);
        g.gain.exponentialRampToValueAtTime(0.001, now + offset + 0.1);
        o.connect(g); g.connect(analyser);
        o.start(now + offset); o.stop(now + offset + 0.12);
      });
    }
  },
  {
    id: 'explosion', name: 'EXPLOSION', jp: '爆発',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      const bufLen = ctx.sampleRate * 0.8;
      const buf = ctx.createBuffer(1, bufLen, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < bufLen; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.15));
      }
      const src = ctx.createBufferSource();
      const filter = ctx.createBiquadFilter();
      const g = ctx.createGain();
      src.buffer = buf;
      filter.type = 'lowpass';
      filter.frequency.value = 400;
      g.gain.setValueAtTime(getVolume() * 2, now);
      g.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
      src.connect(filter); filter.connect(g); g.connect(analyser);
      src.start(now);
    }
  },
  {
    id: 'powerup', name: 'POWER UP', jp: 'パワーアップ',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      [261, 329, 392, 523, 659, 784, 1046].forEach((freq, i) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = freq;
        g.gain.setValueAtTime(getVolume() * 0.7, now + i * 0.06);
        g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.06 + 0.12);
        o.connect(g); g.connect(analyser);
        o.start(now + i * 0.06); o.stop(now + i * 0.06 + 0.15);
      });
    }
  },
  {
    id: 'scan', name: 'RADAR SCAN', jp: 'レーダー走査',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(440, now);
      o.frequency.linearRampToValueAtTime(880, now + 0.5);
      o.frequency.linearRampToValueAtTime(440, now + 1.0);
      g.gain.setValueAtTime(getVolume() * 0.5, now);
      g.gain.setValueAtTime(getVolume() * 0.5, now + 0.9);
      g.gain.exponentialRampToValueAtTime(0.001, now + 1.1);
      o.connect(g); g.connect(analyser);
      o.start(now); o.stop(now + 1.2);
    }
  },
  {
    id: 'dock', name: 'DOCKING OK', jp: 'ドッキング完了',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      [[523, 0], [659, 0.15], [784, 0.3], [1046, 0.45]].forEach(([freq, offset]) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'triangle';
        o.frequency.value = freq;
        g.gain.setValueAtTime(getVolume() * 0.8, now + offset);
        g.gain.exponentialRampToValueAtTime(0.001, now + offset + 0.4);
        o.connect(g); g.connect(analyser);
        o.start(now + offset); o.stop(now + offset + 0.5);
      });
    }
  },
  {
    id: 'glitch', name: 'SYSTEM GLITCH', jp: 'システム異常',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      for (let i = 0; i < 8; i++) {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        const offset = i * 0.04;
        o.type = 'sawtooth';
        o.frequency.value = 100 + Math.random() * 2000;
        g.gain.setValueAtTime(getVolume() * 0.5, now + offset);
        g.gain.exponentialRampToValueAtTime(0.001, now + offset + 0.06);
        o.connect(g); g.connect(analyser);
        o.start(now + offset); o.stop(now + offset + 0.08);
      }
    }
  },
  {
    id: 'teleport', name: 'TELEPORT', jp: 'テレポート',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(2000, now);
      o.frequency.exponentialRampToValueAtTime(200, now + 0.4);
      o.frequency.exponentialRampToValueAtTime(2000, now + 0.8);
      g.gain.setValueAtTime(getVolume(), now);
      g.gain.setValueAtTime(getVolume(), now + 0.7);
      g.gain.exponentialRampToValueAtTime(0.001, now + 0.9);
      o.connect(g); g.connect(analyser);
      o.start(now); o.stop(now + 1);
    }
  },
  {
    id: 'coin', name: 'COLLECT ITEM', jp: 'アイテム取得',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      [784, 1046].forEach((freq, i) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = freq;
        g.gain.setValueAtTime(getVolume() * 0.8, now + i * 0.08);
        g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.08 + 0.15);
        o.connect(g); g.connect(analyser);
        o.start(now + i * 0.08); o.stop(now + i * 0.08 + 0.18);
      });
    }
  },
  {
    id: 'gameover', name: 'MISSION FAIL', jp: 'ミッション失敗',
    fn: () => {
      const ctx = getCtx(); const now = ctx.currentTime;
      [440, 370, 311, 261].forEach((freq, i) => {
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.value = freq;
        g.gain.setValueAtTime(getVolume() * 0.9, now + i * 0.18);
        g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.18 + 0.3);
        o.connect(g); g.connect(analyser);
        o.start(now + i * 0.18); o.stop(now + i * 0.18 + 0.35);
      });
    }
  }
];

function buildSoundBoard() {
  const board = document.getElementById('soundboard');
  SE_LIST.forEach(se => {
    const btn = document.createElement('button');
    btn.className = 'se-btn';
    btn.id = `se-${se.id}`;
    btn.innerHTML = `
      <div class="se-indicator"></div>
      <span class="se-name">${se.name}</span>
      <span class="se-name-jp">${se.jp}</span>
    `;
    btn.onclick = () => {
      se.fn();
      btn.classList.add('playing');
      log(`SE // ${se.name} // 再生`);
      setTimeout(() => btn.classList.remove('playing'), 400);
    };
    board.appendChild(btn);
  });
}

// ===== SLIDERS =====
['tempo', 'vol', 'reverb'].forEach(id => {
  const slider = document.getElementById(`${id}Slider`);
  const val = document.getElementById(`${id}Val`);
  slider.addEventListener('input', () => {
    val.textContent = slider.value;
    if (id === 'tempo' && bgmPlaying) {
      stopBGM(); setTimeout(startBGM, 50);
    }
  });
});

// ===== LOG =====
function log(msg) {
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  el.innerHTML = `<span>[${time}]</span> // ${msg}`;
}

// ===== INIT =====
buildSoundBoard();
</script>
</body>
</html>
